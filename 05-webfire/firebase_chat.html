<!doctype html>
<html>

<head>
  <title>Firebase testing</title>
  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {onValue, ref, getDatabase, set, push} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    import {getAnalytics} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBB4e6YiDTSZGEqcsKR1gKcDOfIFwPB190",
      authDomain: "aigames25jaagup.firebaseapp.com",
      databaseURL: "https://aigames25jaagup-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "aigames25jaagup",
      storageBucket: "aigames25jaagup.firebasestorage.app",
      messagingSenderId: "1096076420551",
      appId: "1:1096076420551:web:2417b0726000b030ae65e2",
      measurementId: "G-EC8543DSNL"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const directory = ref(db, "testsept17");
    //const analytics = getAnalytics(app);
    onValue(directory, display);

    function display(pointer) {
      let data = pointer.val();

      d1.innerHTML = "<ul>" +
        Object.values(data.messages).toReversed().
          map(m => "<li>" + m.user + ": " + m.message + "</li>").
          join("") + "</ul>"
      let g = canvas1.getContext("2d")
      g.clearRect(0, 0, 600, 400)
      for (let uname in data.coordinates) {
        console.log(uname)
        let obj = data.coordinates[uname]

        let userColor = null
        if (obj.color != null){
          userColor = obj.color
        } else {
          userColor = "#000000"
        }
        g.fillStyle = userColor
        g.fillText(uname, obj.x, obj.y)
        g.fillStyle = userColor
        g.fillText(obj.message, obj.x, obj.y - 15)
      }
    }
    let myX = 0, myY = 0
    window.store = function (e) {
      console.log(e)
      myX = e.offsetX
      myY = e.offsetY
      set(ref(db, "testsept17/coordinates/ruben"), {"user": "ruben", "message": text1.value, "x": e.offsetX, "y": e.offsetY, "color": colorInput.value})
    }
    window.writeText = function () {
      set(ref(db, "testsept17/coordinates/ruben"), {"user": "ruben", "message": text1.value, "x": myX, "y": myY, "color": colorInput.value})
      window.setTimeout(window.removeText, 2000)
    }

    window.removeText = function () {
      set(ref(db, "testsept17/coordinates/ruben"), {"user": "ruben", "message": "", "x": myX, "y": myY, "color": colorInput.value})
    }
  </script>
</head>

<body>
  <h1>Hello, Firebase</h1>
  Message:
  <input type="text" id="text1" />
  Color:
  <input type="color" id="colorInput" />
  <!-- X: -->
  <!-- <input type="number" id="text2" /> -->
  <!-- Y: -->
  <!-- <input type="number" id="text3" /> -->
  <input type="button" onclick="writeText()" value="push" />
  <br />
  <canvas id="canvas1" width="600" height="400" onmousedown="window.store(event)">
    <div id="d1">Message place</div>
</body>

</html>
